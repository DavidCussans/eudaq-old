#!/bin/sh
# EUDRBIP=eudetvme001.cern.ch
# TLUIP=eudetpc001.cern.ch
EUDRBIP=mvme6100
TLUIP=tlupc
#TLUIP=eudet
RCPORT=44000
[ "$1" != "" ] && RCPORT=$1

export ROOTSYS=/usr/share/root/

export HOSTNAME=eudet

cd `dirname $0`

printf 'STARTING DAQ\n'
printf '\t Cleaning up first...\n'
killall RootMonitor.exe
killall TestDataCollector.exe
ssh eudet@$EUDRBIP "killall EUDRBProducer.exe" &
killall TLUProducer.exe
ssh eudet@$TLUIP "killall TLUProducer.exe" &
killall DEPFETProducerTCP.exe
killall euLog
killall euRun
sleep 3
printf '\033[1;32;48m\t ...Done!\033[0m \n'

printf '\t Making sure TLU is accessible\n'
ssh eudet@$TLUIP "cd eudaq/bin; ./tlunoroot.exe"
sleep 3

printf '\t Starting Subprocesses\n'
cd bin

printf '\t\t  RunControl\n'
./euRun.app/Contents/MacOS/euRun -x 0 -y 0 -w 350 -g 450 -a tcp://$RCPORT &
sleep 2

printf '\t\t  Logger\n'
./euLog.app/Contents/MacOS/euLog -x 0 -y 450 -w 350 -g 550 -r tcp://eudet:$RCPORT &
sleep 2

printf '\t\t  DataCollector\n'
#./TestDataCollector.exe &
/usr/X11R6/bin/xterm -sb -sl 1000 -geom 80x10-500-290 -fn fixed -e './TestDataCollector.exe -r tcp://eudet:$RCPORT' &
sleep 2

printf '\t\t  RootMonitor\n'
./RootMonitor.exe -x 350 -y 0 -w 1330 -g 900 -r tcp://localhost:$RCPORT &

printf '\t\t  EUDRB\n'
ssh -X -Y eudet@$EUDRBIP "(/usr/X11R6/bin/xterm -sb -sl 1000 -geom 80x10-500-30 -fn fixed -e 'cd eudaq/bin/; ./EUDRBProducer.exe -r tcp://eudet:$RCPORT')" &

printf '\t\t  TLU\n'
ssh -X -Y eudet@$TLUIP "(xterm -sb -sl 1000 -geom 80x10-500-160 -e 'cd eudaq/bin/; ./TLUProducer.exe -r tcp://eudet:$RCPORT')" &

# printf '\t\t  DEPFET\n'
# /usr/X11R6/bin/xterm -sb -sl 1000 -geom 80x40-700-290 -fn fixed -e './DEPFETProducerTCP.exe' &

cd -
printf '\033[1;32;48m\t ...Done!\033[0m \n'
printf '\033[1;32;48mSTART OF DAQ COMPLETE\033[0m \n'

